import shotgun_api3
import pprint

# Creating an API instance
def get_shotgrid(url="https://cphbom.shotgrid.autodesk.com/", script="", key=""):
    return shotgun_api3.Shotgun(url, script_name=script, api_key=key)


PROJECT_FIELDS = [
    "name",
    "id",
    "sg_description",
    "sg_status",
    "users",
    "tank_name",
]

EPISODE_FIELDS = [
    "project",
    "code",
    "id",
    "description",
    "image",
    "sg_status_list",
    "sequence",
]

SEQUENCE_FIELDS = ["project", "code", "id"]

SHOT_FIELDS = ["project", "code", "id"]

sg = get_shotgrid(script="cobopipe", key="fbda0Jg$zihrnynjqhiaywhic")


class Project:
    def __init__(self, fields=None, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        if not self.fields:
            self.fields = PROJECT_FIELDS
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def episodes(self, fields=None):
        if not fields:
            fields = EPISODE_FIELDS
        return get_entity(self.identity, self.type, "episode", fields, Episode)

    def sequences(self, fields=None):
        if not fields:
            fields = SEQUENCE_FIELDS
        return get_entity(self.identity, self.type, "sequence", fields, Episode)

    def shots(self, fields=None):
        if not fields:
            fields = SHOT_FIELDS
        return get_entity(self.identity, self.type, "shot", fields, Episode)

    def __getattr__(self, name: str):
        if name == "episodes":
            return self.episodes()
        elif name == "sequences":
            return self.sequences()
        elif name == "shots":
            return self.shots()
        else:
            return self.__dict__[f"{name}"]


class Episode:
    def __init__(self, fields=None, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        if not self.fields:
            self.fields = EPISODE_FIELDS
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable in self.fields:
                if variable == "name":
                    self.code = "value"
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def sequences(self, fields=None):
        if not fields:
            fields = SEQUENCE_FIELDS
        return get_entity(self.identity, self.type, "sequence", fields, Episode)

    def shots(self, fields=None):
        if not fields:
            fields = SHOT_FIELDS
        return get_entity(self.identity, self.type, "shot", fields, Episode)

    def __getattr__(self, name: str):
        if name == "sequences":
            return self.sequences()
        elif name == "shots":
            return self.shots()
        elif name == "name":
            return self.__dict__["code"]
        else:
            return self.__dict__[f"{name}"]


class Sequence:
    def __init__(self, fields=None, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        if not self.fields:
            self.fields = SEQUENCE_FIELDS
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def shots(self, fields=None):
        if not fields:
            fields = SHOT_FIELDS
        return get_entity(self.identity, self.type, "shot", fields, Episode)

    def __getattr__(self, name: str):
        if name == "shots":
            return self.shots()
        elif name == "name":
            return self.__dict__["code"]
        else:
            return self.__dict__[f"{name}"]


class Shot:
    def __init__(self, fields=None, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        if not self.fields:
            self.fields = SHOT_FIELDS
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def __getattr__(self, name: str):
        if name == "name":
            return self.__dict__["code"]
        else:
            return self.__dict__[f"{name}"]


def repr_entity(self):
    return f"<ShotGrid.{self.__class__.__name__} object>"


def str_entity(self):
    _string = f"\n<ShotGrid.{self.__class__.__name__} object>\n"
    for variable, value in self.__dict__.items():
        if variable in self.fields:
            _string = _string + f"{variable:<10} \t{pprint.pformat(value)}\n"
    return _string


def get_entity(source_identity, source_type, target_type, fields, return_class):
    filters = [[source_type.lower(), "is", source_identity]]
    data = sg.find(target_type.capitalize(), filters=filters, fields=fields)
    objects = []
    for entity in data:
        objects.append(return_class(_update=False, **entity))
    return objects


def update_entity(self):
    filters = []
    for variable, value in self.__dict__.items():
        if variable in self.fields:
            filters.append([variable, "is", value])

    if not filters:
        raise ValueError("Missing filter data")

    data = sg.find(self.type, filters=filters, fields=self.fields)
    for variable, value in data[0].items():
        exec(f"self.{variable} = {repr(value)}")


if __name__ == "__main__":
    project = Project(name="Lego Friends - Wildbrain")
    print(str(project))
    # episodes = project.episodes
