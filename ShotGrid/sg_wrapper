# TODO: Add a class for assets and versions
# TODO: Fill out the default fields to be optimal

import shotgun_api3
import pprint

# Setting default fields of interest
HUMAN_USER_FIELDS = [
    "name",
    "sg_status_list",
    "email",
    "permission_rule_set",
    "projects",
    "groups",
]
PROJECT_FIELDS = ["name", "id", "sg_description", "sg_status", "users", "tank_name"]
EPISODE_FIELDS = [
    "project",
    "code",
    "id",
    "description",
    "sg_status_list",
    "sequence",
]
SEQUENCE_FIELDS = ["project", "code", "id", "description", "sg_status_list"]
SHOT_FIELDS = ["project", "code", "id", "sg_status_list", "sg_cut_duration"]
ASSET_FIELDS = ["project", "code", "id", "sg_status_list", "sg_asset_type", "parents"]
TASK_FIELDS = [
    "project",
    "content",
    "id",
    "entity",
    "step",
    "sg_status_list",
    "task_assignees",
    "start_date",
    "due_date",
    "duration",
]
VERSION_FIELDS = ["project", "code", "id", "sg_status_list"]

# Creating an API instance
def get_shotgrid(url="https://cphbom.shotgrid.autodesk.com/", script="", key=""):
    return shotgun_api3.Shotgun(url, script_name=script, api_key=key)
sg = get_shotgrid(script="cobopipe", key="fbda0Jg$zihrnynjqhiaywhic")


class HumanUser:
    def __init__(self, fields=HUMAN_USER_FIELDS, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def __getattr__(self, name: str):
        return self.__dict__[f"{name}"]


class Project:
    def __init__(self, fields=PROJECT_FIELDS, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def get_users(self, fields=HUMAN_USER_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, self.type, "humanuser", fields, Episode, extra_filters
        )

    def get_episodes(self, fields=EPISODE_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, self.type, "episode", fields, Episode, extra_filters
        )

    def get_sequences(self, fields=SEQUENCE_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, self.type, "sequence", fields, Sequence, extra_filters
        )

    def get_shots(self, fields=SHOT_FIELDS, extra_filters=[]):
        return get_entity(self.identity, self.type, "shot", fields, Shot, extra_filters)

    def get_assets(self, fields=ASSET_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, self.type, "asset", fields, Asset, extra_filters
        )

    def get_tasks(self, fields=TASK_FIELDS, extra_filters=[]):
        return get_entity(self.identity, self.type, "task", fields, Task, extra_filters)

    def get_versions(self, fields=VERSION_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, self.type, "version", fields, Version, extra_filters
        )

    def __getattr__(self, name: str):
        return_dictionary = {
            "users": self.get_users,
            "episodes": self.get_episodes,
            "sequences": self.get_sequences,
            "shots": self.get_shots,
            "assets": self.get_assets,
            "tasks": self.get_tasks,
            "versions": self.get_versions,
        }

        if name in return_dictionary.keys():
            return return_dictionary[name]()
        else:
            self.__dict__[f"{name}"]


class Episode:
    def __init__(self, fields=EPISODE_FIELDS, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable == "name":
                self.code = value
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def get_sequences(self, fields=SEQUENCE_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, self.type, "sequence", fields, Sequence, extra_filters
        )

    def get_shots(self, fields=SHOT_FIELDS, extra_filters=[]):
        shots = []
        for sequence in self.get_sequences():
            shots = shots + get_entity(
                sequence.identity, "sg_sequence", "shot", fields, Shot, extra_filters
            )
        return shots

    def get_assets(self, fields=ASSET_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, "episodes", "asset", fields, Asset, extra_filters
        )

    def get_tasks(self, fields=TASK_FIELDS, extra_filters=[]):
        return get_entity(self.identity, "entity", "task", fields, Asset, extra_filters)

    def get_versions(self, fields=VERSION_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, "entity", "version", fields, Version, extra_filters
        )

    def __getattr__(self, name: str):
        return_dictionary = {
            "sequences": self.get_sequences,
            "shots": self.get_shots,
            "assets": self.get_assets,
            "tasks": self.get_tasks,
            "versions": self.get_versions,
        }

        if name in return_dictionary.keys():
            return return_dictionary[name]()
        elif name == "name":
            return self.__dict__["code"]
        else:
            return self.__dict__[f"{name}"]


class Sequence:
    def __init__(self, fields=SEQUENCE_FIELDS, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable == "name":
                self.code = value
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def get_shots(self, fields=SHOT_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, "sg_sequence", "shot", fields, Shot, extra_filters
        )

    def get_assets(self, fields=ASSET_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, "sequence", "asset", fields, Asset, extra_filters
        )

    def get_tasks(self, fields=TASK_FIELDS, extra_filters=[]):
        return get_entity(self.identity, "entity", "task", fields, Task, extra_filters)

    def get_versions(self, fields=VERSION_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, "entity", "version", fields, Version, extra_filters
        )

    def __getattr__(self, name: str):
        return_dictionary = {
            "shots": self.get_shots,
            "assets": self.get_assets,
            "tasks": self.get_tasks,
            "versions": self.get_versions,
        }

        if name in return_dictionary.keys():
            return return_dictionary[name]()
        elif name == "name":
            return self.__dict__["code"]
        else:
            return self.__dict__[f"{name}"]


class Shot:
    def __init__(self, fields=SHOT_FIELDS, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable == "name":
                self.code = value
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def get_assets(self, fields=ASSET_FIELDS, extra_filters=[]):
        return get_entity(self.identity, "shots", "asset", fields, Asset, extra_filters)

    def get_tasks(self, fields=TASK_FIELDS, extra_filters=[]):
        return get_entity(self.identity, "entity", "task", fields, Task, extra_filters)

    def get_versions(self, fields=VERSION_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, "entity", "version", fields, Version, extra_filters
        )

    def __getattr__(self, name: str):
        return_dictionary = {
            "assets": self.get_assets,
            "tasks": self.get_tasks,
            "versions": self.get_versions,
        }

        if name in return_dictionary.keys():
            return return_dictionary[name]()
        elif name == "name":
            return self.__dict__["code"]
        else:
            return self.__dict__[f"{name}"]


class Asset:
    def __init__(self, fields=ASSET_FIELDS, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable == "name":
                self.code = value
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def get_tasks(self, fields=TASK_FIELDS, extra_filters=[]):
        return get_entity(self.identity, "entity", "task", fields, Task, extra_filters)

    def get_versions(self, fields=VERSION_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, "entity", "version", fields, Version, extra_filters
        )

    def __getattr__(self, name: str):
        return_dictionary = {
            "tasks": self.get_tasks,
            "versions": self.get_versions
        }

        if name in return_dictionary.keys():
            return return_dictionary[name]()
        elif name == "name":
            return self.__dict__["code"]
        else:
            return self.__dict__[f"{name}"]


class Task:
    def __init__(self, fields=TASK_FIELDS, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable == 'name':
                self.content = value
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def get_versions(self, fields=VERSION_FIELDS, extra_filters=[]):
        return get_entity(
            self.identity, "sg_task", "version", fields, Version, extra_filters
        )

    def __getattr__(self, name: str):
        return_dictionary = {"versions": self.get_versions}

        if name in return_dictionary.keys():
            return return_dictionary[name]()
        elif name == "name":
            return self.__dict__["content"]
        else:
            return self.__dict__[f"{name}"]


class Version:
    def __init__(self, fields=VERSION_FIELDS, **kwargs):
        if not kwargs:
            raise ValueError("Missing identifying keyword arguments like name or id")

        self.fields = fields
        self.type = self.__class__.__name__

        for variable, value in kwargs.items():
            if variable == 'name':
                self.code = value
            if variable in self.fields:
                exec(f"self.{variable} = {repr(value)}")

        update_entity(self)
        self.identity = {"type": self.type, "id": self.id}

    def __repr__(self):
        return repr_entity(self)

    def __str__(self):
        return str_entity(self)

    def __getattr__(self, name: str):
        return_dictionary = {"versions": self.get_versions}

        if name in return_dictionary.keys():
            return return_dictionary[name]()
        elif name == "name":
            return self.__dict__["content"]
        else:
            return self.__dict__[f"{name}"]


def repr_entity(self):
    return f"<ShotGrid.{self.__class__.__name__} object>"


def str_entity(self):
    _string = f"\n<ShotGrid.{self.__class__.__name__} object>\n"
    for variable, value in self.__dict__.items():
        if variable in self.fields:
            _string = _string + f"{variable:<10} \t{pprint.pformat(value)}\n"
    return _string


def get_entity(
    source_identity, source_type, target_type, fields, return_class, extra_filters=[]
):
    filters = [[source_type.lower(), "is", source_identity]]
    filters = filters + extra_filters
    data = sg.find(target_type.capitalize(), filters=filters, fields=fields)
    objects = []
    for entity in data:
        objects.append(return_class(_update=False, **entity))
    return objects


def update_entity(self):
    filters = []
    for variable, value in self.__dict__.items():
        if variable in self.fields:
            if value:
                filters.append([variable, "is", value])

    if not filters:
        raise ValueError("Missing filter data")

    # print(f"\n\nfilters: {filters}\nfields: {self.fields}\n\n")
    data = sg.find(self.type, filters=filters, fields=self.fields)
    if not data:
        return
    for variable, value in data[0].items():
        exec(f"self.{variable} = {repr(value)}")


if __name__ == "__main__":
    asset = Asset(name="BallOfYarn")
    for task in asset.tasks:
        for version in task.versions:
            print(version)
